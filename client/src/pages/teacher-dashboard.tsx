import { useQuery, useMutation } from "@tanstack/react-query";
import { Reservation } from "@shared/schema";
import { AdminLayout } from "@/components/layout";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Textarea } from "@/components/ui/textarea";
import { apiRequest, queryClient } from "@/lib/queryClient";
import { useToast } from "@/hooks/use-toast";
import { 
  Loader2, 
  MapPin, 
  Globe, 
  Clock, 
  CheckCircle2, 
  MessageCircle, 
  ImageIcon, 
  XCircle,
  Footprints,
  Maximize2,
  Camera, // ì¶”ê°€ë¨
  X // ì¶”ê°€ë¨
} from "lucide-react";
import { useState } from "react";
import { format, isSameDay } from "date-fns";
import { ko } from "date-fns/locale";
import { Badge } from "@/components/ui/badge";
import {
  Dialog,
  DialogContent,
  DialogTrigger,
} from "@/components/ui/dialog";

export default function TeacherDashboard() {
  const { toast } = useToast();
  // í”¼ë“œë°± í…ìŠ¤íŠ¸ ê´€ë¦¬
  const [feedback, setFeedback] = useState<{ [key: number]: string }>({});
  // âœ¨ [ì¶”ê°€] ì„ ìƒë‹˜ì´ ì—…ë¡œë“œí•  ì‚¬ì§„ ê´€ë¦¬ (ì˜ˆì•½ IDë³„ë¡œ ê´€ë¦¬)
  const [feedbackImages, setFeedbackImages] = useState<{ [key: number]: File | null }>({});
  const [feedbackPreviews, setFeedbackPreviews] = useState<{ [key: number]: string | null }>({});

  const { data: reservations, isLoading } = useQuery<Reservation[]>({
    queryKey: ["/api/teacher/all"],
  });

  // âœ¨ [ìˆ˜ì •] ì‚¬ì§„ ì—…ë¡œë“œ ë¡œì§ì´ í¬í•¨ëœ ë‹µë³€ ì „ì†¡ í•¨ìˆ˜
  const respondMutation = useMutation({
    mutationFn: async ({ id, feedbackText }: { id: number; feedbackText: string }) => {
      let photoUrl = "";

      // 1. ë§Œì•½ ì‚¬ì§„ì´ ì„ íƒë˜ì–´ ìˆë‹¤ë©´ ë¨¼ì € ì—…ë¡œë“œ
      const imageFile = feedbackImages[id];
      if (imageFile) {
        const formData = new FormData();
        formData.append("file", imageFile);
        const res = await fetch("/api/upload", { method: "POST", body: formData });
        if (!res.ok) throw new Error("ì´ë¯¸ì§€ ì—…ë¡œë“œ ì‹¤íŒ¨");
        const data = await res.json();
        photoUrl = data.url;
      }

      // 2. ë‹µë³€ ë‚´ìš©ê³¼ ì‚¬ì§„ URLì„ í•¨ê»˜ ì „ì†¡
      await apiRequest("PATCH", `/api/reservations/${id}`, {
        status: "answered",
        teacherFeedback: feedbackText,
        teacherPhotoUrl: photoUrl || null, // âœ¨ DBì— ì‚¬ì§„ ì£¼ì†Œ ì €ì¥
      });
    },
    onSuccess: (_, variables) => {
      queryClient.invalidateQueries({ queryKey: ["/api/teacher/all"] });
      toast({ title: "ì²˜ë¦¬ ì™„ë£Œ", description: "ë‹µë³€ê³¼ ì‚¬ì§„ì´ ì „ì†¡ë˜ì—ˆìŠµë‹ˆë‹¤." });

      // ì…ë ¥ì°½ ì´ˆê¸°í™”
      setFeedback(prev => ({ ...prev, [variables.id]: "" }));
      setFeedbackImages(prev => ({ ...prev, [variables.id]: null }));
      setFeedbackPreviews(prev => ({ ...prev, [variables.id]: null }));
    },
    onError: (error: Error) => {
      toast({ title: "ì˜¤ë¥˜ ë°œìƒ", description: error.message, variant: "destructive" });
    },
  });

  const cancelMutation = useMutation({
    mutationFn: async (id: number) => {
      await apiRequest("PATCH", `/api/reservations/${id}`, {
        status: "cancelled",
        teacherFeedback: "ì„ ìƒë‹˜ì— ì˜í•´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.",
      });
    },
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ["/api/teacher/all"] });
      toast({ title: "ì˜ˆì•½ ì·¨ì†Œ", description: "ì§ˆë¬¸ì´ ì·¨ì†Œ ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤." });
    },
  });

  // ì´ë¯¸ì§€ ì„ íƒ í•¸ë“¤ëŸ¬
  const handleImageSelect = (id: number, e: React.ChangeEvent<HTMLInputElement>) => {
    const file = e.target.files?.[0];
    if (file) {
      setFeedbackImages(prev => ({ ...prev, [id]: file }));
      const reader = new FileReader();
      reader.onloadend = () => {
        setFeedbackPreviews(prev => ({ ...prev, [id]: reader.result as string }));
      };
      reader.readAsDataURL(file);
    }
  };

  // ì´ë¯¸ì§€ ì‚­ì œ í•¸ë“¤ëŸ¬
  const removeImage = (id: number) => {
    setFeedbackImages(prev => ({ ...prev, [id]: null }));
    setFeedbackPreviews(prev => ({ ...prev, [id]: null }));
  };

  if (isLoading) {
    return (
      <AdminLayout>
        <div className="flex justify-center items-center h-[50vh]">
          <Loader2 className="h-8 w-8 animate-spin text-primary" />
        </div>
      </AdminLayout>
    );
  }

  const pendingReservations = reservations?.filter(r => r.status === 'pending') || [];
  const completedReservations = reservations?.filter(r => 
    r.status === 'answered' && 
    isSameDay(new Date(r.createdAt || new Date()), new Date())
  ) || [];

  return (
    <AdminLayout>
      <div className="space-y-8 max-w-5xl mx-auto">
        {/* í†µê³„ ì¹´ë“œ (ê¸°ì¡´ ë™ì¼) */}
        <div className="grid gap-4 md:grid-cols-3">
          <Card className="bg-white shadow-sm border-blue-100">
            <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2"><CardTitle className="text-sm font-medium text-muted-foreground">ëŒ€ê¸° ì¤‘ì¸ ì§ˆë¬¸</CardTitle><Clock className="h-4 w-4 text-blue-500" /></CardHeader>
            <CardContent><div className="text-2xl font-bold text-blue-600">{pendingReservations.length}ê±´</div></CardContent>
          </Card>
          <Card className="bg-white shadow-sm border-green-100">
            <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2"><CardTitle className="text-sm font-medium text-muted-foreground">ì˜¤ëŠ˜ ì²˜ë¦¬ ì™„ë£Œ</CardTitle><CheckCircle2 className="h-4 w-4 text-green-500" /></CardHeader>
            <CardContent><div className="text-2xl font-bold text-green-600">{completedReservations.length}ê±´</div></CardContent>
          </Card>
          <Card className="bg-white shadow-sm border-orange-100">
            <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2"><CardTitle className="text-sm font-medium text-muted-foreground">í˜„ì¥ ì§ˆë¬¸ ëŒ€ê¸°</CardTitle><MapPin className="h-4 w-4 text-orange-500" /></CardHeader>
            <CardContent><div className="text-2xl font-bold text-orange-600">{pendingReservations.filter(r => r.type === 'onsite').length}ê±´</div></CardContent>
          </Card>
        </div>

        {/* ì§ˆë¬¸ ë¦¬ìŠ¤íŠ¸ */}
        <div className="space-y-4">
          <h2 className="text-xl font-bold flex items-center gap-2">ğŸš€ ë‹µë³€ì´ í•„ìš”í•œ ì§ˆë¬¸ ({pendingReservations.length})</h2>
          {pendingReservations.length === 0 ? (
            <div className="text-center py-20 bg-white rounded-xl border border-dashed text-muted-foreground">ëŒ€ê¸° ì¤‘ì¸ ì§ˆë¬¸ì´ ì—†ìŠµë‹ˆë‹¤. ì ì‹œ íœ´ì‹ì„ ì·¨í•˜ì„¸ìš”! â˜•ï¸</div>
          ) : (
            <div className="grid gap-4">
              {pendingReservations.map((res) => (
                <Card key={res.id} className="overflow-hidden border-l-4 border-l-primary shadow-sm hover:shadow-md transition-shadow">
                  <CardContent className="p-6">
                    <div className="flex flex-col md:flex-row gap-6">

                      {/* í•™ìƒ ì§ˆë¬¸ ë‚´ìš© (ê¸°ì¡´ ë™ì¼) */}
                      <div className="flex-1 space-y-4">
                        <div className="flex items-center justify-between">
                          <div className="flex items-center gap-2">
                            <Badge variant="outline" className={`px-3 py-1 rounded-full text-sm font-bold flex items-center gap-1 ${res.type === 'onsite' ? "bg-orange-50 text-orange-600 border-orange-200" : "bg-blue-50 text-blue-600 border-blue-200"}`}>
                              {res.type === 'onsite' ? <MapPin className="w-3 h-3" /> : <Globe className="w-3 h-3" />}{res.type === 'onsite' ? "í˜„ì¥ ì§ˆë¬¸" : "ì˜¨ë¼ì¸ ì§ˆë¬¸"}
                            </Badge>
                            <span className="text-sm text-gray-400">{format(new Date(res.createdAt || new Date()), "p", { locale: ko })} ìš”ì²­</span>
                          </div>
                          <div className="text-right"><span className="text-lg font-bold mr-2">{res.studentName} í•™ìƒ</span><Badge variant="secondary" className="text-xs">ì¢Œì„ {res.seatNumber}</Badge></div>
                        </div>
                        <div className="bg-gray-50 p-4 rounded-xl text-gray-800 leading-relaxed border border-gray-100">{res.content === "(ë‚´ìš© ì—†ìŒ)" || !res.content ? <span className="text-gray-400 italic">ë‚´ìš© ì—†ìŒ (ì‚¬ì§„ì„ í™•ì¸í•˜ì„¸ìš”)</span> : res.content}</div>

                        {/* í•™ìƒ ì‚¬ì§„ ë³´ê¸° */}
                        {res.photoUrls && res.photoUrls.length > 0 && (
                          <Dialog>
                            <div className="flex flex-col items-start gap-3">
                              <h4 className="text-sm font-bold text-slate-700 flex items-center gap-1"><ImageIcon className="w-4 h-4" /> í•™ìƒ ì²¨ë¶€ ì‚¬ì§„</h4>
                              <DialogTrigger asChild>
                                <div className="relative group cursor-pointer">
                                  <img src={res.photoUrls[0]} alt="í•™ìƒ ì§ˆë¬¸ ì‚¬ì§„" className="w-auto h-36 rounded-xl border border-gray-200 object-cover shadow-sm transition-all group-hover:brightness-90" />
                                  <div className="absolute inset-0 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity"><div className="bg-black/50 text-white p-2 rounded-full"><Maximize2 className="w-5 h-5" /></div></div>
                                </div>
                              </DialogTrigger>
                            </div>
                            <DialogContent className="max-w-4xl bg-transparent border-none shadow-none p-0 flex items-center justify-center">
                              <img src={res.photoUrls[0]} alt="í•™ìƒ ì§ˆë¬¸ ì‚¬ì§„ ì „ì²´" className="max-w-[90vw] max-h-[90vh] rounded-2xl shadow-2xl object-contain" />
                            </DialogContent>
                          </Dialog>
                        )}
                      </div>

                      {/* ì„ ìƒë‹˜ ë‹µë³€ ì˜ì—­ */}
                      <div className="md:w-80 flex flex-col gap-3 border-l pl-0 md:pl-6 md:border-l-gray-100">
                        {res.type === 'onsite' ? (
                          <div className="h-full flex flex-col justify-center gap-4">
                            <div className="bg-orange-50/80 border border-orange-100 p-5 rounded-2xl flex flex-col items-center justify-center gap-2 text-center shadow-sm">
                              <div className="p-2 bg-white rounded-full shadow-sm"><Footprints className="w-5 h-5 text-orange-500" /></div>
                              <p className="text-orange-900 font-bold text-sm">ì„ ìƒë‹˜ì´ ë°©ë¬¸í•˜ì—¬ ì§€ë„í•˜ëŠ” ì§ˆë¬¸ì…ë‹ˆë‹¤.</p>
                            </div>
                            <Button onClick={() => respondMutation.mutate({ id: res.id, feedbackText: "í˜„ì¥ ì§ˆë¬¸ í™•ì¸ ë° ì§€ë„ ì™„ë£Œ" })} disabled={respondMutation.isPending} className="w-full py-6 text-lg font-bold bg-orange-500 hover:bg-orange-600 shadow-orange-200 shadow-lg transition-transform active:scale-95">
                              {respondMutation.isPending ? <Loader2 className="w-5 h-5 animate-spin" /> : "í™•ì¸ ì™„ë£Œ (ì§€ë„ ë)"}
                            </Button>
                            <Button variant="ghost" onClick={() => cancelMutation.mutate(res.id)} className="text-gray-400 hover:text-red-500 hover:bg-red-50"><XCircle className="w-4 h-4 mr-2" /> ì˜ˆì•½ ì·¨ì†Œì‹œí‚¤ê¸°</Button>
                          </div>
                        ) : (
                          <div className="flex flex-col gap-3 h-full">
                            <label className="text-sm font-bold flex items-center gap-2 text-blue-700"><MessageCircle className="w-4 h-4" /> ë‹µë³€ ì‘ì„±</label>

                            {/* ë‹µë³€ í…ìŠ¤íŠ¸ ì…ë ¥ */}
                            <Textarea
                              placeholder="ë‹µë³€ì„ ì…ë ¥í•˜ì„¸ìš”..."
                              value={feedback[res.id] || ""}
                              onChange={(e) => setFeedback({ ...feedback, [res.id]: e.target.value })}
                              className="flex-1 min-h-[100px] resize-none border-blue-100 focus:border-blue-400"
                            />

                            {/* âœ¨ [ì¶”ê°€] ë‹µë³€ ì‚¬ì§„ ì—…ë¡œë“œ UI */}
                            <div>
                              <input 
                                id={`teacher-file-${res.id}`} 
                                type="file" 
                                accept="image/*" 
                                className="hidden" 
                                onChange={(e) => handleImageSelect(res.id, e)} 
                              />

                              {feedbackPreviews[res.id] ? (
                                <div className="relative w-full h-32 rounded-lg overflow-hidden border border-blue-200 group">
                                  <img src={feedbackPreviews[res.id]!} alt="Preview" className="w-full h-full object-cover" />
                                  <div className="absolute top-1 right-1 bg-black/60 p-1 rounded-full cursor-pointer hover:bg-red-500 transition-colors" onClick={() => removeImage(res.id)}>
                                    <X className="w-4 h-4 text-white" />
                                  </div>
                                </div>
                              ) : (
                                <Button 
                                  variant="outline" 
                                  size="sm" 
                                  className="w-full border-dashed border-blue-300 text-blue-500 hover:bg-blue-50"
                                  onClick={() => document.getElementById(`teacher-file-${res.id}`)?.click()}
                                >
                                  <Camera className="w-4 h-4 mr-2" /> í’€ì´ ì‚¬ì§„ ì²¨ë¶€í•˜ê¸°
                                </Button>
                              )}
                            </div>

                            <div className="flex gap-2 mt-auto pt-2">
                              <Button variant="outline" onClick={() => cancelMutation.mutate(res.id)} className="flex-1 text-gray-500">ë°˜ë ¤</Button>
                              <Button 
                                onClick={() => respondMutation.mutate({ id: res.id, feedbackText: feedback[res.id] || "ë‹µë³€ ì™„ë£Œ (ì‚¬ì§„ í™•ì¸)" })} 
                                disabled={respondMutation.isPending || (!feedback[res.id] && !feedbackImages[res.id])} 
                                className="flex-[2] font-bold bg-blue-600 hover:bg-blue-700"
                              >
                                {respondMutation.isPending ? <Loader2 className="w-4 h-4 animate-spin" /> : "ë‹µë³€ ì „ì†¡"}
                              </Button>
                            </div>
                          </div>
                        )}
                      </div>
                    </div>
                  </CardContent>
                </Card>
              ))}
            </div>
          )}
        </div>
      </div>
    </AdminLayout>
  );
}